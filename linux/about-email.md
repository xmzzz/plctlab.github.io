# 有关电子邮件

从使用者角度，电子邮件已经非常方便了。除常用的收发功能之外，如果你对更多有关邮件系统的知识还不熟悉，可以阅读下面的内容。

## 收发邮件的底层过程

邮件系统也是由几个复杂部分连接成的，一封邮件从你的客户端发出之后，都经历了哪些环节呢？先看一下整体过程，再来说明每个环节是什么。

```
发件人:MUA --发送--> MTA -> 若干个MTA... -> MTA -> MDA <--收取-- MUA:收件人
```

* MUA (Mail User Agent，邮件用户代理)

MUA 就是我们日常使用的邮件客户端，比如常用的 thunderbird, outlook，或者网页客户端等。


* MTA (Mail Transfer Agent，邮件传输代理)

MUA 不是直接将邮件发送到收件人邮箱，而是通过MTA代为传递，常见扮演 MTA 角色的有 sendmail 和 msmtp。


* MDA(Mail Delivery Agent，邮件投递代理)

一封邮件从 MUA 发出后，一般会通过一个或多个 MTA 传递，最终到达 MDA ，这时 MDA 就会把这封邮件存放在**某个文件**或**特殊的数据库**里，这样就把邮件长期保存起来。可以理解为邮件存到了邮箱里。邮件一旦到达邮箱，就会保持原地不动，并等待接收者用 MUA 读取邮件，这就完成了一个完整的电子邮件收发过程。

## 邮件的存储格式

用 MUA 阅读邮件时，有时会选择将邮件下载到本地，这样之后就可以离线阅读。邮件在本地以什么格式存储呢？常见的存储格式有 mbox, maildir 。

* mbox

mbox 的特点是将一个文件夹中的所有邮件存储到同一个文件中。

* maildir

maildir 的特点是每个邮件是用一个单独的文件存储，那么当一个文件中邮件数量很多时，相应的存储文件也会很多。

thunderbird 默认使用 mbox 格式存储邮件。https://lore.kernel.org 上的邮件提供的下载格式也是 mbox 。

* git 仓库

整个 https://lore.kernel.org 背后是基于 public-inbox 提供的 http 服务，public-inbox 是用 git 仓库的格式存储邮件的，例如每封邮件相当于一个 git commit，并有一个 commit id。这种存储格式使得我们 clone 一个完整的邮件列表镜像非常容易。而这也是 public-inbox 设计者的初衷之一 ———— 去中心化。Linux 内核本身的开发演化是非常强调去中心化的，即不依赖于任何一个中心服务端。邮件列表作为内核开发协作的主要载体，同样应该考虑去中心化。Linux 内核演进的 30 年里，邮件列表服务端出现过不少，现在有些还存在，但有不少已经消失了，这就给检索完整的归档造成了困难。这是 public-inbox 项目的目标之一。

## 邮件相关的各种协议

常见的邮件协议有 POP3, IMAP, SMTP, NNTP。可以通过选择使用某种协议来改变收发邮件的方式。发送邮件时，在 MUA 到 MTA，以及 MTA 到 MTA 之间使用的协议是 SMTP 协议。而收邮件时，MUA 到 MDA 之间使用的常见协议是 POP3 或 IMAP。

* POP3 (Post Office Protocol 3)

POP3 协议允许 MUA 下载 MDA 服务器上的邮件，但是在 MUA 进行的操作（如移动邮件、标记已读等），不会反馈到服务器上。比如对 thunderbird 用户最直观的影响就是在本地建立的 filter 过滤条件和分类的邮箱文件夹并不会同步到服务器上。因此如果换另外一台设备，或者用新的 MUA 读取邮件就看不到这些文件夹。

老的 POP 协议读取邮件后，邮件就会从 MDA 服务器上删除，相当于邮件 move 到了本地。而现在新的 POP3 协议已经支持在服务器上保留已阅读的邮件。

* IMAP (Internet Mail Access Protocol)

IMAP 协议最大的特点是，用户在 MUA 上对邮箱的操作会同步到服务器上，这样的好处就是方便在不同设备或者 MUA 上收取邮件的场景。IMAP 还有一个重要特点，就是用户可以只先收取标题等部分信息，等具体查看邮件时再下载内容。

* SMTP (Simple Mail Transfer Protocol)

SMTP 是用来发送邮件的，是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。

* NNTP （Network News Transfer Protocol)

网络新闻传输协议。可以通过 NNTP 订阅内核邮件列表的新闻服务，特点是先下载邮件标题而不下载内容，而是在阅读的时候下载内容。邮件内容存来自 NNTP 服务器，而不是自己邮件账户的服务器，因此不用订阅接收该邮件列表就可以查看所有邮件内容。但是阅读是以只读的方式，不能像 IMAP 那样对邮件进行操作。

## 常用 MUA 简介

* mutt

如果本地下载了邮件，用 mutt 可以方便的阅读邮件。mutt 是一个小巧但很强大的命令行邮件客户端。比如在 https://lore.kernel.org/linux-riscv 上任何一封邮件的页面下方找到下载 mbox 的链接，下载到本地后可以通过下面命令阅读邮件：

	$ mutt -f ./xxx.mbox

* thunderbird

支持 SMTP, POP3, IMAP, NNTP, RSS等。默认以 mbox 的格式存储邮件。
